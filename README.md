# Biomedicalfluid dynamics with a particular focus on cerebral blood flow - Gemini code
The following is a useful reference document for users of the code in project Gemini. This is a project looking to model the various scenarios of acute ischaemic stroke in a virtual population of patients, with the overarching goal of running an ’in silico’ or ’virtual’ clinical trial, which will be eventually accessible to medical professionals.

## Overview
This project uses the finite element method (FEM) as the primary solution strategy for modeling acute ischemic stroke. To achieve this, we utilise FEniCSx, an open-source finite element solver for partial differential equations. <br> As of October 2024, the latest version of FEniCSx is 0.9, which reprensents an evolution from its predecessor, FEniCS legacy. This document outlines key aspects of the transition between these versions. <br> FEniCSx consists of several core libraries, including UFL, Basix, FFCx and DOLFINx, all of which are available on GitHub. Compared to the legacy version, FEniCSx introduces several improvements, such as expanded support for various cell types and elements, enhanced memory parallelization and complex number support. <br> These advancements make FEniCSx a powerful and efficient tool for simulating ischemic stroke dynamics.

This repository contains software corresponding to WP5 of the INSIST project (https://www.insist-h2020.eu/).

## Table of Contents
- [Installation](#installation)
- [Usage](#usage)
- [Structure](#structure)
- [Contribution](#contribution)
- [License](#license)

## Installation
To install this project, run the following command
Provide examples of how to install and use the project 

Accessing FEniCSx on Cresent: <br>
>module use /apps2/modules/all <br>
>module load CONDA/FEniCSx-0.9 <br>
>python3 <br>
>import dolfinx <br>
>`dolfinx.__version__`  <br>
>exit()

## Usage
### Run the 3D blood flow solver
1. Extract `brain_meshes.tar.xz` placed in the main repository
2. Compute the permeability tensor with `permeability_initialiser.py`. For parallel execution, use `mpirun -n #number_of_processors python3 permeability_initialiser.py`. Using 4 cores execution takes typically less than 2 minutes. Parameters are obtained from the `config_permeability_initialiser.yaml` file. This script has to be executed only once.
3. Compute the pressure and the velocity field using the `basic_flow_solver.py`. The solver can be executed in parallel to compute the healthy perfusion field with `mpirun -n #number_of_processors python3 complex_geom_solver.py`. Using 4 cores and first order finite elements, the execution is typically less than 2 minute. Parameters are obtained from the `config_basic_flow_solver.yaml` file.
4. For occluded scenarios a boundary condition fiel has to be used to specify pressure/volumetric flow rate through cortical surface territories. `BC_template.csv` contains an example for right MCA occlusion. Similar files can be generated by running the `BC_creator.py` file (in serial): `python3 BC_creator.py`

In the *.csv summarising the boundary conditions the cortical surface regions are numbered so that 21 - left ACA 22 - left MCA 23 - left PCA 24 - right ACA 25 - right MCA 26 - right PCA

To use the `BC_template.csv`, the config file has to be edited as shown in the `config_basic_flow_solver_RMCAo.yaml` file.

To run the 3D oxygen solver:
1. Follow instructions to run the 3D blood flow solver (`perfusion_runner.sh`) to obtain the inputs for the oxygen model.
2. Compute oxygen concentration distriution with `oxygen_main.py`. For parallel execution, use `mpirun -n #number_of_processors python3 oxygen_mmain.py`. Using 6 cores and first order finite elements, the execution is slighly over 2 minutes.
Notes: there are still some numerical instability in the results. To visualise the results set data range to 0-0.2 in paraview. 

### FEniCS--->FEniCSx
FEniCS Documentation: https://olddocs.fenicsproject.org/dolfin/2017.1.0/python/py-modindex.html
FEniCSx Documentation: https://docs.fenicsproject.org/dolfinx/main/python/api.html#python

### GitHub
To update github:
>git status <br>
>git add . <br>
>git status <br>
>git commit -m "description of change" <br>
>git push origin <br>

To clone a repositry: 
>git clone -b branch-name url

## Structure 
Folders: 
- [perfusion](#perfusion)
- [oxygen](#oxygen)
- [sensitivity](#sensitivity)
- [tissue_health](#tissue_health)

Files: 
| Function | Description | 
|----------|----------|
| .dockerignore | Specifies files and directories thaat should be ignored when building a Docker image. |
| .gitignore | Lists files and directories that Git should ignore in a repository. |
| .gitlab-ci.vml | Specifies automated tasks that GitLab should execute whe, changes are pushed. |
| .gitmodules | Contains configuration for Git submodules, which are repositories nested within another repository (in our case, in-silico-trial.git) |
| API.py | |
| Dockerfile | |
| LICENSE | |
| README.md | |
| VP_mesh_prep.py | |
| brain_meshes.tar.xz | |
| build_and_run_docker_image_sh | |
| cleaner.sh | |
| coupled_perfusion_runner.sh | |
| documentation.pdf | | 
| documentation.tex | | 
| perfusion_runner.sh | |
| perfusion_runner_mod_geom.sh | | 
| requirements.txt | It is the version requirements for each library. |
| runner.py | |
| singularity.def | |
| test_patient.yml | |

Notes: 
- instead of different files of API, gather together in one and only file
- the same can be done for IO_fcts, finite_element_fcts and documentation/README
- Replace some functions in IO_fcts with functions in dolfinx.io
- create a class parameters with the parameters private and functions to get the parameters
  => good idea? do parameters change constansly?

### perfusion
Folders: 
- boundary_data: ...
- config_examples: ...
- verification: ...
  
Files:
| Function | Description | 
|----------|----------|
| API.py | |
| BC_creator.py | Reads the brain mesh and creates boundary conditions by distributing the average volumetric flow rate of blood to the brain on the boundaries based on their surface area. |
| BC_template_LMCAo.csv | |
| BC_template_RMCAo.csv | |
| IO_fcts.py | Functions for reading and processing mesh and configuration files used in a Darcy flow simulation. It includes utilities for handling XML and YAML input, reading permeability data, and saving results in various formats.|
| Perfusion_yamls.zip | |
| README.md| |
| basic_flow_solver.py | Multi-compartment Darcy flow model with mixed Dirichlet and Neumann boundary conditions. |
| config_basic_flow_solver.yaml | |
| config_basic_flow_solver_LMCAo.yaml | |
| config_basic_flow_solver_RMCAo.yaml | |
| config_coupled_flow_solver.xml | | 
| config_permeability_initialiser.yaml | |
| convert_msh2hdf5.py | |
| convert_res2img.py | |
| coupled_flow_solver.py | |
| description.tex | |
| finite_element_fcts.py | |
| infarct_calculation.py | Multi-compartment Darcy flow model with mixed Dirichlet and Neumann boundary conditions |
| infarct_calculation_thresholds.py | Multi-compartment Darcy flow model with mixed Dirichlet and Neumann boundary conditions|
| lesion_comp_from_img.py | |
| new_basic_flow_solver.py | |
| new_permeability_initialiser.py | ?The same as `permeability_initialiser.py` but with FEniCSx |
| opt_res_plotter.py | |
| parameter_calculation.py | |
| parameter_optimiser.py | |
| permeability_initialiser.py | Generates an anisotropic permeability field based on a predefined form of the permeability tensor given in a reference coordinate system.  |
| suppl_fcts.py | |

Notes: 
- suppl_fcts.py, can be added in the files IO_fcts.py
- what is the difference between `infarct_calculation.py`and `infarct_calculation_thresholds` ?

### oxygen
| Function | Description |
|----------|----------|
| API.py | Create a class named API |
| FE_solver.py | |
| IO_funcs.py | Defining functions |
| README.md | instruction for running this section |
| config_oxygen_solver.yaml | Configuration of input/ouput and parameters |
| depth_func_DG.h5 | |
| oxygen_main.py | Multi-compartment advection-reaction-diffusion problem describing oxygen transport in the brain |
| to_be_implemented.txt | It is a list for the next action |

### tissue_health
Folder: beta_versions: A folders with the original files of the GEMINI-DTH repository

Files:
| Function | Description |
|----------|----------|
| API.py| Create a class named API |
| IO_fcts.py | Defining functions |
| README.md | Explaning the infract treatment |
| config_propagation.yaml | Configuration by default of the propagation (RMCAo)|
| config_propagation_LMCAo.yaml | |
| config_tissue_damage.yaml | Configuration of tissue damage by default with Input-Ouput-Parameter |
| finite_element_fcts.py | Implementing functions to use the finite element method/analysis |
| infarct_estimate_treatment.py | Estimate the tissue health (infarct fraction) based on perfusion in each element and the green's function simulation results |
| infarct_estimate_treatment_FEM.py | Model the evolution of tissue damage and recovery using the finite element method |
| suppl_fcts.py | Defining functions |
| tissue_damage.sh | Running the `infarct_estimate_treatment.py` |
| tissue_health_propagation.py | Estimate the infract volume using a tissue health model with vulnerability propagation |
| to_be_implemented.txt | It is a list for the next action |

Notes: 
- suppl_fcts.py, can be added in the files IO_fcts.py
- `infarct_estimate_treatment_FEM.py` is still under FEniCS
- Why is there two programs for infract_estimate_treatment ? => possibility to do one file where the two methods are inside one by default and the other one called with arguments
- In `finite_element_fcts.py` the script in FEniCS is in comment. Can we delete that part ? Or to have two
- Idea: create a class named FEM where all the functions implemented are for finite elements. Is there already some functions already implemented in labraries of FEniCSx ???

### sensitivity 
| Function | Description |
|----------|----------|
|IO_fcts.py | Defining functions |
| clear.sh | Shell commands to remove specific files and directories  |
| comp_infarcted_volume.py | Analyse perfusion changes in brain tissue due to an occlusion, compares healthy to RMCA. Insight into how much brain tissue is at risk due to the occlussion |
| finite_element_fcts.py |
| infarct_calculation.py | Multi-compartement Darcy flow model with mixed Dirichlet and Neumann boundary conditions |
| param_mapping_runner.py | Run multiple simulations with different configurations |
| perfusion_parameter_sampling.py | Generates YAML configuration files for a sensitivity analysis by varying two permeability parameters in each part of the brain for gray matter |
| plot_sensitivity_results.py | Analyse and visualise the sensitivity of infarct volume to permeability parameters |
| sensitivity.sh | Automates the entire sensitivity analysis workflow for a multi-compartment Darcy flow model |
| suppl_fcts.py | Defining functions |

Notes: 
- suppl_fcts.py, can be added in the files IO_fcts.py
- `comp_infarcted_volume.py`and `infarct_calculation.py` are kinda the same scripts but the method is different ; calculating the infarct volume 
