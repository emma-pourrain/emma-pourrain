# Biomedicalfluid dynamics with a particular focus on cerebral blood flow - Gemini code
Here is a brief description of the project 

The following is a useful reference document for users of the code in project Gemini. This is a project looking to model the various scenarios of acute ischaemic stroke in a virtual population of patients, with the overarching goal of running an ’in silico’ or ’virtual’ clinical trial, which will be eventually accessible to medical professionals.
The primary solution strategy is the finite element method. The open source software FEniCSx is used as a convenient and effective finite element solver for the partial differential equations modelling acute ischaemic stroke. At time of writing the latest version of FEniCSx is from October 2024, that is FEniCSx (0.9). FEniCSx is an evolution of the previous version FEniCS Legacy - this document will describe some aspects of this translation. FEniCSx is comprised of the libraries UFL, Basix, FFCx, and DOLFINx, which are also available on Github. Some improvements on the legacy version include a wide range of available cell types and elements, memory parallelisation, and complex number support.

This repository contains software corresponding to WP5 of the INSIST project (https://www.insist-h2020.eu/).
## Overview
This section should provude a high-level overview of the project's purpose and goals

## Table of Contents
- [Installation](#installation)
- [Usage](#usage)
- [Structure](#structure)
- [Contribution](#contribution)
- [License](#license)

## Installation
To install this project, run the following command
Provide examples of how to install and use the project 

## Usage
### Run the 3D blood flow solver
1. Extract `brain_meshes.tar.xz` placed in the main repository
2. Compute the permeability tensor with `permeability_initialiser.py`. For parallel execution, use `mpirun -n #number_of_processors python3 permeability_initialiser.py`. Using 4 cores execution takes typically less than 2 minutes. Parameters are obtained from the `config_permeability_initialiser.yaml` file. This script has to be executed only once.
3. Compute the pressure and the velocity field using the `basic_flow_solver.py`. The solver can be executed in parallel to compute the healthy perfusion field with `mpirun -n #number_of_processors python3 complex_geom_solver.py`. Using 4 cores and first order finite elements, the execution is typically less than 2 minute. Parameters are obtained from the `config_basic_flow_solver.yaml` file.
4. For occluded scenarios a boundary condition fiel has to be used to specify pressure/volumetric flow rate through cortical surface territories. `BC_template.csv` contains an example for right MCA occlusion. Similar files can be generated by running the `BC_creator.py` file (in serial): `python3 BC_creator.py`

In the *.csv summarising the boundary conditions the cortical surface regions are numbered so that 21 - left ACA 22 - left MCA 23 - left PCA 24 - right ACA 25 - right MCA 26 - right PCA

To use the BC_template.csv, the config file has to be edited as shown in the config_basic_flow_solver_RMCAo.yaml file.

### FEniCS--->FEniCSx
FEniCS Documentation: https://olddocs.fenicsproject.org/dolfin/2017.1.0/python/py-modindex.html
FEniCSx Documentation: https://docs.fenicsproject.org/dolfinx/main/python/api.html#python

### GitHub
To update github:
>git status <br>
>git add . <br>
>git status <br>
>git commit -m "description of change" <br>
>git push origin <br>

To clone a repositry: 
>git clone -b branch-name url

## Structure 
Folders: 
- [perfusion](#perfusion)
- [oxygen](#oxygen)
- [sensitivity](#sensitivity)
- [tissue_health](#tissue_health)

Files: 
| Function | Description | 
|----------|----------|
| .dockerignore | Specifies files and directories thaat should be ignored when building a Docker image. |
| .gitignore | Lists files and directories that Git should ignore in a repository. |
| .gitlab-ci.vml | Specifies automated tasks that GitLab should execute whe, changes are pushed. |
| .gitmodules | Contains configuration for Git submodules, which are repositories nested within another repository (in our case, in-silico-trial.git) |
| API.py | |
| Dockerfile | |
| LICENSE | |
| README.md | |
| VP_mesh_prep.py | |
| brain_meshes.tar.xz | |
| build_and_run_docker_image_sh | |
| cleaner.sh | |
| coupled_perfusion_runner.sh | |
| documentation.pdf | | 
| documentation.tex | | 
| perfusion_runner.sh | |
| perfusion_runner_mod_geom.sh | | 
| requirements.txt | It is the version requirements for each library. |
| runner.py | |
| singularity.def | |
| test_patient.yml | |

Notes: 
- instead of different files of API, gather together in one and only file
- the same can be done for IO_fcts, finite_element_fcts and documentation/README
- Replace some functions in IO_fcts with functions in dolfinx.io 

### perfusion
Folders: 
- boundary_data: ...
- config_examples: ...
- verification: ...
  
Files:
- [API.py](#API.py): ...
- [BC_creator.py](#BC_creator.py): ...
- [BC_template_LMCAo.csv](#BC_template_LMCAo.csv): ...
- [BC_template_RMCAo.csv](#BC_template_RMCAo.csv): ...
- [IO_fcts.py](#IO_fcts.py): ...
- [Perfusion_yamls.zip](#Perfusion_yaml.zip): ...
- [README.md](#README.md): ...
- [basic_flow_solver.py](#basic_flow_solver.py):...
- [config_basic_flow_solver.yaml](#config_basic_flow_solver.yaml):...
- [config_basic_flow_solver_LMCAo.yaml](#config_basic_flow_solver_LMCAo.yaml): ...
- [config_basic_flow_solver_RMCAo.yaml](#config_basic_flow_solver_RMCAo.yaml): ...
- [config_coupled_flow_solver.xml](#config_coupled_flow_solver.xml):...
- [config_permeability_initialiser.yaml](#config_permeability_initialiser.yaml): ...
- [convert_msh2hdf5.py](#convert_msh2hdf5.py):...
- [convert_res2img.py](#convert_res2img.py): ...
- [coupled_flow_solver.py](#coupled_flow_solver.py): ..
- description.tex
- finite_element_fcts.py
- infarct_calculation.py
- infarct_calculation_thresholds.py
- lesion_comp_from_img.py
- new_basic_flow_solver.py
- new_permeability_initialiser.py
- opt_res_plotter.py
- parameter_calculation.py
- parameter_optimiser.py
- permeability_initialiser.py
- suppl_fcts.py

Notes: suppl_fcts.py, can be added in the files IO_fcts.py

### oxygen
| Function | Description |
|----------|----------|
| API.py | |
| FE_solver.py | |
| IO_funcs.py | |
| README.md | instruction for running this section |
| config_oxygen_solver.yaml | |
| depth_func_DG.h5 | |
| oxygen_main.py | |
| to_be_implemented.txt | It is a list for the next action |

### tissue_health
Folder: beta_versions: A folders with the original files of the GEMINI-DTH repository

Files:
| Function | Description |
|----------|----------|
| API.py| Create a class named API |
| IO_fcts.py | Defining functions |
| README.md | Explaning the infract treatment |
| config_propagation.yaml | Configuration by default of the propagation (RMCAo)|
| config_propagation_LMCAo.yaml | |
| config_tissue_damage.yaml | Configuration of tissue damage by default with Input-Ouput-Parameter |
| finite_element_fcts.py | Implementing functions to use the finite element method/analysis |
| infarct_estimate_treatment.py | Estimate the tissue health (infarct fraction) based on perfusion in each element and the green's function simulation results |
| infarct_estimate_treatment_FEM.py | Model the evolution of tissue damage and recovery using the finite element method |
| suppl_fcts.py | Defining functions |
| tissue_damage.sh | Running the `infarct_estimate_treatment.py` |
| tissue_health_propagation.py | Estimate the infract volume using a tissue health model with vulnerability propagation |
| to_be_implemented.txt | It is a list for the next action |

Notes: 
- suppl_fcts.py, can be added in the files IO_fcts.py
- `infarct_estimate_treatment_FEM.py` is still under FEniCS
- Why is there two programs for infract_estimate_treatment ? => possibility to do one file where the two methods are inside one by default and the other one called with arguments
- In `finite_element_fcts.py` the script in FEniCS is in comment. Can we delete that part ? Or to have two
- Idea: create a class named FEM where all the functions implemented are for finite elements. Is there already some functions already implemented in labraries of FEniCSx ???

### sensitivity 
- [IO_fcts.py](#IO_fcts.py): ...
- clear.sh
- [comp_infearcted_volume.py](#comp_infarcted_volume.py): ...
- [finite_element_fcts.py](#finite_element_fcts.py): ...
- [infarct_calculation.py](#infarct_calulation.py): ...
- [param_mapping_runner.py](#param_mapping_runner.py): ...
- [perfusion_parameter_sampling.py](#perfusion_parameter_sampling.py): ...
- [plot_sensitivity_results.py](#plot_sensitivity_results.py): ...
- sensitivity.sh
- [suppl_fcts.py](#suppl_fcts.py): ...

Notes: suppl_fcts.py, can be added in the files IO_fcts.py


------------------------------------------------------------------------------------------------

### IO_fcts.py
|Function|Input | Output | Description | 
|----------|----------|----------|----------|
| mesh_reader    | mesh_file   | mesh, subdomains, boundaries   | This function is useful for loading mesh data and its regions in parallel computing environments |
| argument_reader    | parser   | parser   | This function is part of a script that processes command-line arguments |
| perm_init_config_reader    | input_file_path   | mesh_file, e_ref, K1_form, res_fldr, save_subres | This function is designed to read and parse an XML configuration file related to permeability initialisation in a finite element simulation. (extract input parameters, ensure numerical data correctly formatted) |
| basic_flow_config_reader | input_file_path | mesh_file, read_inlet_boundary, inlet_boudary_file, inlet_BC_type, permeability_folder, p_arterial, p_venous, K1gm_ref, K2gm_ref, K3gm_ref, gmowm_perm_rat, beat12gm, betagm, gmowm_beta_rat, fe_degr, res_fldr, save_pvd, comp_ave |  |
| basic_flow_config_reader2 | input_file_path, parser | configs | |
| input_file_reader | input_file_path | mesh_file, p_arterial, p_venous, e_ref, K1_ref, K2_ref, K3_ref, beta, fe_degr, res_fldr, pial_surf_file, inflow_file | |
| inlet_file_reader | inlet_boundary_file | boundary_data | |
| initialise_permeabilities | K1_space, K2_space, mesh, permeability_folder | K1, K2,K1.copy(deepcopy=True) | |
| pvd_saver | variable, folder, name | | |
| hdf5_saver | mesh, variable, folder, file_name, variable_name | | |
| hdf5_reader | mesh, variable, folder, file_name, variable_name | | |

Class: dict2obj(dict) 
-> function: _init_ 

### comp_infarcted_volume.py
Description: 

### finite_element_fcts.py
| Function | Input | Output | Description | 
|----------|----------|----------|----------|
| mesh_reader | mesh_file | mesh, subdomains, boundaries | |
|alloc_fct_spaces | mesh, fe_f=degr | Vp, Vvel, v_1, v_2, v_3, p, p_1, p_2,p_3, K1_space, K2_space ||
|set_up_fe_solver | mesh, V, v_1, v_2, v_3, p, p_1, p_2, p_3, K1, K2, K3, beta12, beta13, beat 21, beta23, beta31, beta 32, boundaries, pa, pv, subdomains, inflow,_file | LHS, RHS, sigma1, sigma2, sigma3, b1, b2, b3, arteriolesboundnary, venulesboundary, boundaryids | |
| set_up_fe_solver2 | mesh, subdomains, boundaries, V, v_1, v_2, v_3, p, p_1, p_2, p_3, K1, K2, K3, beta12, beta23, pa, pv, read_inlet_boundary, inlet_boundary_file, inlet_BC_type | LHS, RHS, sigma1, sigma2, sigma3, BCs | |
| solve_lin_sys | Vp, LHs, RHS, BCs, lin_solver, precond, rtcol, mon_cinv, init_sol | p | |

### infarct_calulation.py
Description: ....

### param_mapping_runner.py
Description: ...
### perfusion_parameter_sampling.py
Description: ...
### plot_sensitivity_results.py
Description: ...
### suppl_fcts.py
| Function | Input | Output | Description | 
|----------|----------|----------|----------|
| set_coupling_coeff | beta | beta12, beta13, beta21, beta23, beta31, beta32 | |
| comp_vessel_orientation| subdomains, boundaries, mesh, res_fldr, save_subres | e, main_direction | |
| perm_tens_comp | K_space, subdomains, mesh, e_ref, e_loc, K1_form | K1 | |
| scale_permeabilities | subdomains, K1, K2, K3, K1_ref_gm, K2_ref_gm, K2_km_ref_gm, gmowm_prem_rat, res_fldr, save_pvd | K1, K2, K3 | |
| scale_coupling_coefficients | subdomains, beta12gm, beta23gm, gmowm_beta_rat, K2_space, res_fldr, save_pvd | beta12, beta23 | |
| comp_transf_mat| e0, e1 | T | |
| perm_tens_comp_old | K_space, subdomains, mesh, e0, K1_ref, K2_ref, K3_ref, pial_surf_file | K1, K2, K3 | |
| surface_ave | mesh, boundaries, vels, ps | np.array(fluxes), np.array(surf_p_values) | |
| infarct_vol | mesh, subdomains, infarct | np.array(vol_p_values) | |
| perfusion_vol | mesh, subdomains, perfusion | np.array(vol_p_values) | |
| vol_ave | mesh, subdomains, ps, vels | np.array(vol_p_values), np.array(vol_vel_values) | |
| region_label_assembler | region | reion_labels, n_labels | |
